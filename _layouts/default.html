<!-- _layouts/default.html -->
<!doctype html>
<html lang="en">
<head>
<footer>
  <!-- other footer content -->

  <div id="app-version-footer" style="font-size:12px; text-align:center; opacity:0.7; margin-top:20px;">
    Reliable Store India — App Version: <strong></strong>
  </div>
</footer>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const el = document.querySelector("#app-version-footer strong");
    if (el) el.textContent = window.APP_VERSION;
  });
</script>
  
  <script>
  window.APP_VERSION = "1.0.0";   
  window.APP_CHANGELOG = `
    • Faster loading  
    • Improved performance  
    • Minor bug fixes  
  `;
</script>

  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>{{ page.title | default: site.title }}</title>
  <link rel="icon" type="image/png" sizes="32x32" href="/assets/icons/favicon.png" />
  <link rel="apple-touch-icon" sizes="180x180" href="/assets/icons/apple-touch-icon.png" />
  <link rel="stylesheet" href="/assets/css/styles.css" />
  <meta name="theme-color" content="#FE9900" />

  <!-- PWA: Manifest -->
<link rel="manifest" href="/manifest.webmanifest">

<!-- PWA: Theme color -->
<meta name="theme-color" content="#1f2933">

<!-- Android app-like experience -->
<meta name="mobile-web-app-capable" content="yes">
<meta name="application-name" content="Reliable Store India">

<!-- iOS (optional but good) -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="apple-mobile-web-app-title" content="Reliable Store India">
<link rel="apple-touch-icon" href="/icons/icon-192.png">

</head>
<body>
  {% include header.html %}

  <main>
    {{ content }}
  </main>

  {% include footer.html %}

  <!-- lightweight page behaviour -->
  <script>
    // sticky header shadow on scroll
    (function(){
      const bar = document.querySelector('.site-topbar');
      if (!bar) return;
      const onScroll = () => {
        if (window.scrollY > 12) bar.classList.add('scrolled');
        else bar.classList.remove('scrolled');
      };
      document.addEventListener('scroll', onScroll, {passive:true});
      onScroll();
    })();
  </script>

  <!-- Supabase client + header behaviour -->
  <script type="module" src="/assets/js/supabase_client.js"></script>
  <script type="module" src="/assets/js/site_header.js"></script>

<!-- PWA service worker register + update handler -->
<script>
  // Insert or ensure your service-worker register uses this code (one-time)
  if ('serviceWorker' in navigator) {
    (async () => {
      try {
        const reg = await navigator.serviceWorker.register('/service-worker.js');
        console.log('Service worker registered with scope:', reg.scope);

        // If there's already a waiting worker (e.g., updated while page closed), show update UI
        if (reg.waiting) {
          showUpdateUI(reg);
        }

        reg.addEventListener('updatefound', () => {
          const newSW = reg.installing;
          newSW.addEventListener('statechange', () => {
            // When the new SW is installed and there's an existing controller, it means update is ready
            if (newSW.state === 'installed' && navigator.serviceWorker.controller) {
              showUpdateUI(reg);
            }
          });
        });

        // Optional: listen for controllingchange to auto-reload when new SW becomes active
        navigator.serviceWorker.addEventListener('controllerchange', () => {
          console.log('Controller changed — reloading to activate new service worker');
          window.location.reload();
        });
      } catch (err) {
        console.error('Service worker registration failed:', err);
      }
    })();
  }

  // ---------- UI + action ----------
  function showUpdateUI(registration) {
    // Create a small fixed banner if not already present
    if (document.getElementById('pwa-update-banner')) return;

    const banner = document.createElement('div');
    banner.id = 'pwa-update-banner';
    banner.innerHTML = `
      <div style="display:flex;align-items:center;gap:12px;padding:10px 14px;border-radius:8px;
                  background:#111;color:#fff;position:fixed;left:12px;right:12px;bottom:20px;
                  box-shadow:0 6px 18px rgba(0,0,0,0.2);z-index:999999;font-family:Arial, sans-serif;">
        <div style="flex:1;font-size:15px;">A new version is available.</div>
        <button id="pwa-update-apply" style="background:#fff;border:none;padding:8px 12px;border-radius:6px;cursor:pointer;">Update</button>
        <button id="pwa-update-later" style="background:transparent;border:1px solid rgba(255,255,255,0.2);color:#fff;padding:8px 12px;border-radius:6px;cursor:pointer;margin-left:8px;">Later</button>
      </div>
    `;
    document.body.appendChild(banner);

    document.getElementById('pwa-update-apply').addEventListener('click', async () => {
      // Tell waiting SW to skipWaiting
      if (!registration || !registration.waiting) return;
      registration.waiting.postMessage({ type: 'SKIP_WAITING' });
      // After we ask SW to skipWaiting, 'controllerchange' event will fire and we auto reload
    });

    document.getElementById('pwa-update-later').addEventListener('click', () => {
      const b = document.getElementById('pwa-update-banner');
      if (b) b.remove();
    });
  }
</script>

  <!-- service-worker registration + update listener -->
<script>
  ... (your full update script here) ...
</script>
  
</body>
</html>

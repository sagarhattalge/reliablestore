<!-- _layouts/default.html -->
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>{{ page.title | default: site.title }}</title>

  <!-- icons / favicons -->
  <link rel="icon" type="image/png" sizes="32x32" href="/assets/icons/favicon.png" />
  <link rel="apple-touch-icon" sizes="180x180" href="/assets/icons/apple-touch-icon.png" />

  <!-- main stylesheet -->
  <link rel="stylesheet" href="/assets/css/styles.css" />

  <!-- PWA: single theme color (keep consistent) -->
  <meta name="theme-color" content="#1f2933" />

  <!-- PWA: Manifest -->
  <link rel="manifest" href="/manifest.webmanifest">

  <!-- Android app-like -->
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="application-name" content="Reliable Store India">

  <!-- iOS (optional) -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="Reliable Store India">
  <link rel="apple-touch-icon" href="/icons/icon-192.png">

  <!-- PWA app version + changelog (single source of truth) -->
  <script>
    // Update these values whenever you release a new version
    window.APP_VERSION = "v1.0.1";
    window.APP_CHANGELOG = `
      • Faster product page load
      • Improved checkout flow
      • Bug fixes and polish
    `;
  </script>

</head>
<body>
  {% include header.html %}

  <main>
    {{ content }}
  </main>

  {% include footer.html %}

  <!-- Version badge in footer (visible) -->
  <div id="app-version-footer" style="font-size:12px; text-align:center; opacity:0.7; margin:18px 0 28px;">
    Reliable Store India — App Version: <strong></strong>
  </div>

  <!-- lightweight page behaviour -->
  <script>
    // sticky header shadow on scroll
    (function(){
      const bar = document.querySelector('.site-topbar');
      if (!bar) return;
      const onScroll = () => {
        if (window.scrollY > 12) bar.classList.add('scrolled');
        else bar.classList.remove('scrolled');
      };
      document.addEventListener('scroll', onScroll, {passive:true});
      onScroll();
    })();
  </script>

  <!-- Supabase client + header behaviour -->
  <script type="module" src="/assets/js/supabase_client.js"></script>
  <script type="module" src="/assets/js/site_header.js"></script>

  <!-- PWA service worker register + polished update handler -->
  <script>
  if ('serviceWorker' in navigator) {
    (async () => {
      try {
        const reg = await navigator.serviceWorker.register('/service-worker.js');
        console.log('Service worker registered with scope:', reg.scope);

        // If there's already a waiting worker (e.g., updated while page closed), show update UI
        if (reg.waiting) showUpdateUI(reg);

        reg.addEventListener('updatefound', () => {
          const newSW = reg.installing;
          newSW.addEventListener('statechange', () => {
            if (newSW.state === 'installed' && navigator.serviceWorker.controller) {
              showUpdateUI(reg);
            }
          });
        });

        navigator.serviceWorker.addEventListener('controllerchange', () => {
          // new SW activated — reload to use new content
          window.location.reload();
        });
      } catch (err) {
        console.error('Service worker registration failed:', err);
      }
    })();
  }

  function showUpdateUI(registration) {
    if (document.getElementById('pwa-update-sheet')) return;

    // Container
    const sheet = document.createElement('div');
    sheet.id = 'pwa-update-sheet';
    sheet.innerHTML = `
      <div class="pwa-sheet-panel">
        <div class="pwa-sheet-head">
          <div class="pwa-sheet-title">New version available — <span id="pwa-ver"></span></div>
          <button id="pwa-close-x" aria-label="Close">&times;</button>
        </div>
        <div class="pwa-sheet-body">
          <div class="pwa-sheet-changelog" id="pwa-changelog"></div>
        </div>
        <div class="pwa-sheet-actions">
          <button id="pwa-update-apply" class="pwa-btn-primary">Update</button>
          <button id="pwa-update-later" class="pwa-btn-ghost">Later</button>
        </div>
      </div>
    `;
    document.body.appendChild(sheet);

    // Fill version & changelog
    const verEl = document.getElementById('pwa-ver');
    const chEl = document.getElementById('pwa-changelog');
    if (verEl) verEl.textContent = window.APP_VERSION || 'new';
    if (chEl) chEl.innerHTML = (window.APP_CHANGELOG || '').replace(/\n/g, '<br>');

    // Actions
    document.getElementById('pwa-update-apply').addEventListener('click', () => {
      if (!registration || !registration.waiting) return;
      registration.waiting.postMessage({ type: 'SKIP_WAITING' });
      // controllerchange will reload page
    });

    const removeSheet = () => {
      const el = document.getElementById('pwa-update-sheet');
      if (el) el.remove();
    };

    document.getElementById('pwa-update-later').addEventListener('click', removeSheet);
    document.getElementById('pwa-close-x').addEventListener('click', removeSheet);

    // Show the sheet with transition
    sheet.classList.add('pwa-sheet-show');
  }
  </script>

  <!-- Fill footer version (runs after footer element exists) -->
  <script>
    (function(){
      const el = document.querySelector("#app-version-footer strong");
      if (el) el.textContent = window.APP_VERSION || '';
    })();
  </script>

</body>
</html>

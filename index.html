<script>
  const products = [
    { id: 1, name: 'Fast Charger 30W', price: 699, img: '/assets/uploads/charger-300x200.webp' },
    { id: 2, name: 'Type-C Cable 1m', price: 249, img: '/assets/uploads/cable-300x200.webp' },
    { id: 3, name: 'Power Bank 20000mAh', price: 1299, img: '/assets/uploads/powerbank-300x200.webp' }
  ];

  function getCart() {
    try { return JSON.parse(localStorage.getItem('rs_cart_v1') || '{}'); } catch(e){ return {}; }
  }
  function setCart(cart) {
    localStorage.setItem('rs_cart_v1', JSON.stringify(cart));
    // trigger storage event for same-tab listeners
    window.dispatchEvent(new Event('storage'));
  }

  function renderProducts() {
    const list = document.getElementById('product-list');
    list.innerHTML = '';
    products.forEach(p => {
      const el = document.createElement('div');
      el.className = 'feature';
      el.innerHTML = `
        <img src="${p.img}" alt="${p.name}" loading="lazy" style="height:160px;object-fit:contain;margin-bottom:12px"/>
        <h3 style="font-size:16px">${p.name}</h3>
        <p style="font-weight:700;margin:8px 0">₹${p.price}</p>
        <button class="btn btn-primary w-100" data-add="${p.id}">Add to Cart</button>
      `;
      list.appendChild(el);
    });

    // wire add buttons
    list.querySelectorAll('[data-add]').forEach(btn => {
      btn.addEventListener('click', () => addToCart(Number(btn.getAttribute('data-add'))));
    });
  }

  function addToCart(id) {
    const p = products.find(x => x.id === id);
    if (!p) return;
    const cart = getCart();
    const key = 'p' + id;
    if (!cart[key]) cart[key] = { id: p.id, title: p.name, price: p.price, qty: 0 };
    cart[key].qty = (cart[key].qty || 0) + 1;
    setCart(cart);
    // header script listens to storage event and will update #cart-count
    // For immediate feedback in-page, also update UI badge
    const badge = document.getElementById('cart-count') || document.getElementById('cart_count');
    if (badge) badge.textContent = Object.values(cart).reduce((s,i)=> s + (i.qty||0), 0);
  }

  function doSearch() {
    const q = document.getElementById('searchInput').value.trim().toLowerCase();
    if (!q) return alert('Enter a search term');
    const results = products.filter(p => p.name.toLowerCase().includes(q));
    const list = document.getElementById('product-list');
    list.innerHTML = '';
    results.forEach(p => {
      const el = document.createElement('div');
      el.className = 'feature';
      el.innerHTML = `
        <img src="${p.img}" alt="${p.name}" loading="lazy" style="height:160px;object-fit:contain;margin-bottom:12px"/>
        <h3 style="font-size:16px">${p.name}</h3>
        <p style="font-weight:700;margin:8px 0">₹${p.price}</p>
      `;
      list.appendChild(el);
    });
  }

  document.addEventListener('DOMContentLoaded', renderProducts);
</script>
